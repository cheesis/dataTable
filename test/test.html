<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="style2.css">
<script src="3rd_party\numeral.js"></script>

<script>
// testing number formatting
// load a language
numeral.language('sv', {
    delimiters: {
        thousands: ' ',
        decimal: ','
    },
    abbreviations: {
        thousand: 'k',
        million: 'm',
        billion: 'b',
        trillion: 't'
    },
    ordinal : function (number) {
        return number === 1 ? 'e' : 'e';
    },
    currency: {
        symbol: 'SEK'
    }
});

// switch between languages
numeral.language('sv');

// from here http://stackoverflow.com/questions/5778020/check-whether-an-input-string-contains-number
function isNumeric(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
}

function formatNumber(d) {
    if (isNumeric(d)) {
        return numeral(d).format('0,0.0000');
    }
    else {
        return d;
    }
}
</script>
<script src="table.js"></script>


<!--
  stuff for our form

<link rel="stylesheet" href="3rd_party\uikit.min.css" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="3rd_party\uikit.min.js"></script>
-->


</head>
<body>
  <form action="inbound" method="post" class="noprint uk-form" id="mainform">
    <div class="uk-form-row">
        <input type="text" placeholder="Order Program Id" name="opid">
        <textarea cols="16" rows="5" placeholder="Sales Order Id" name="soids"></textarea>
    </div>
    <div class="uk-form-row">
      <button type="button" onclick="formCB();">Submit</button>
    </div>
  </form>
<script type="text/javascript">
/**
started out with Madara Uchiha's answer at http://stackoverflow.com/questions/6990729/simple-ajax-form-using-javascript-no-jquery
modified according to http://www.html5rocks.com/en/tutorials/es6/promises/

* Takes a form node and sends it over AJAX.
* @param {HTMLFormElement} form - Form node to send
* @param {function} callback - Function to handle onload.
*                              this variable will be bound correctly.
*/

function ajaxPost(form) {
  // Return a new promise.
  return new Promise(function(resolve, reject) {
    var url = form.action,
        xhr = new XMLHttpRequest();

    //This is a bit tricky, [].fn.call(form.elements, ...) allows us to call .fn
    //on the form's elements, even though it's not an array. Effectively
    //Filtering all of the fields on the form
    var params = [].filter.call(form.elements, function(el) {
        //Allow only elements that don't have the 'checked' property
        //Or those who have it, and it's checked for them.
        return typeof(el.checked) === 'undefined' || el.checked;
        //Practically, filter out checkboxes/radios which aren't checekd.
    }).join('&');
    // .filter(function(el) { return !!el.name; } //Nameless elements die.
    // .filter(function(el) { return el.disabled; } //Disabled elements die.
    // .map(function(el) {
    //     //Map each field into a name=value string, make sure to properly escape!
    // }).join('&'); //Then join all the strings by &
    //     return encodeURIComponent(el.name) + '=' + encodeURIComponent(el.value);

    xhr.open("POST", url);
    xhr.setRequestHeader("Content-type", "application/x-form-urlencoded");

    //.bind ensures that this inside of the function is the XHR object.
    xhr.onload = function() {
        // This is called even on 404 etc
        // so check the status
        if (xhr.status == 200) {
          // Resolve the promise with the response text
          resolve(xhr.response);
        }
        else {
          // Otherwise reject with the status text
          // which will hopefully be a meaningful error
          reject(Error(xhr.statusText));
        }
      };

      // Handle network errors
      xhr.onerror = function() {
        reject(Error("Network Error"));
      };
    //All preperations are clear, send the request!
    xhr.send(params);
  });
}

// time to shine
function formCB() {
  ajaxPost(document.getElementById('mainform')).then(function (response) {
    console.log("Success!", response);
    myTable.populate(JSON.parse(response));
  }).catch(function (error) {
    console.log("Failed!", error);
  });
}
</script>

<table id="st"></table>
<table id="sot"></table>

<script type="text/javascript">
/*
    here we fill the sales order table
*/
  //names of columns in header
  var sot_base = {
      section: "",
      columns: [
            {columnName:"oid",displayName:"Sales Order Ids"}
          , {columnName:"bs",displayName:"Buy/Sell"}
          , {columnName:"avgPrice",displayName:"Average Price"}
          , {columnName:"quantity",displayName:"Quantity"}
          , {columnName:"tradedValue",displayName:"Traded Value", calc:tradedValue}
          , {columnName:"pctOfValue",displayName:"% of program value", calc:pctOfValue}
      ]
  };
  var vwap_columns = {
      section: "VWAP",
      columns: [
           {columnName:'vwapAvgPrice',displayName:'Average Price'}
          ,{columnName:'vwapVolume',displayName:'Volume'}
          ,{columnName:'vwapPart',displayName:'Participation', calc:participation}
          ,{columnName:'vwapPnL',displayName:'P&L', calc:pnl}
          ,{columnName:'vwapPnLbps',displayName:'P&L Bps', calc:pnlbps}
      ]
  };
  var sot_definition = [sot_base, vwap_columns];

  //columns that should have a value in the footer
  var sot_foot = [{columnName:"quantity", calc:fsumQuantity}, // we need named functions if we want to define them after this
                  {columnName:"avgPrice", calc:fAvgPrice},
                  {columnName:"tradedValue", calc:tradedValue}
                 ];
  var sot_foot_vwap = [
    {columnName:"vwapPnL", calc:fsumVWAPPnL},
    {columnName:"vwapPnLbps", calc:fVWAPPnLbps}
  ];

  // add the vwap footer values
  sot_foot = [].concat(sot_foot, sot_foot_vwap);

  function tradedValue(things) {
    return things.getColInRow("avgPrice") * things.getColInRow("quantity");
  }
  function pctOfValue(things) {
    var totalValue = things.getColInFootRow("avgPrice") * things.getColInFootRow("quantity");
    return things.getColInRow("tradedValue") / totalValue * 100;
  }
  function participation(things) {
      return things.getColInRow("quantity")/things.getColInRow("vwapVolume")*100;
  }
  function pnl(things) {
    var difference = 0;
    if (things.getColInRow("bs") == "B") {
      difference = things.getColInRow("vwapAvgPrice") - things.getColInRow("avgPrice");
    } else if(things.getColInRow("bs") == "S"){
      difference = things.getColInRow("avgPrice") - things.getColInRow("vwapAvgPrice");
    }
    else {
      difference = 0;
      console.log('buy/sell was neither b nor s in pnl(), it was ' + things.getColInRow("bs"));
    }
    return things.getColInRow("quantity") * difference;
  }
  function pnlbps(things) {
    return things.getColInRow("vwapPnL") / (things.getColInRow("avgPrice") * things.getColInRow("quantity")) * 10000;
  }
  function fVWAPPnLbps(things) {
    return things.getColInFootRow("vwapPnL") / (things.getColInFootRow("avgPrice") * things.getColInFootRow("quantity")) * 10000;
  }

  function fsumQuantity(things) {
      //this calculates the sum of the column values
      return things.getCol("quantity").sum();//.sum();
  };
  function fsumVWAPPnL(things) {
    return things.getCol("vwapPnL").sum();
  };

  function fAvgPrice(things){
      var quantities = things.getCol("quantity");
      var prices = things.getCol("avgPrice");

      //quantities * prices
      var product = quantities.map(function(x, index){ //here x = quantities[index]
        return prices[index] * x;
      });

      //sum(product)/sum(quantities)
      return product.sum() /
        quantities.sum();
  }

  //sales order table data
  var sotd = [
      // {oid:"oim1", avgPrice:12.5, quantity:20000, bs:"B"},
      {oid:"oim2", avgPrice:50.456, quantity:10000, bs:"S"},
      {oid:"oim3", avgPrice:50.456, quantity:10000, bs:"S", NBV:1230}
  ];
  //we can't assume that we get the data back in the right order
  var bm_data = [
        {oid:"oim2",vwapAvgPrice:50, vwapVolume:50000}
      , {oid:"oim3",vwapAvgPrice:60, vwapVolume:60000}
  ];
  var later_bm_data = [{oid:"oim1",vwapAvgPrice:12, vwapVolume:1000}];


  var myTable = new dataTable("sot",sot_definition, "oid", sot_foot, formatNumber);
  myTable.populate(sotd);
  myTable.populate(bm_data);
  // adds more data after the given time
  setTimeout(function(){ myTable.populate(later_bm_data); }, 2000);
  setTimeout(function(){
    myTable.populate([{oid:"oim1", avgPrice:12.5, quantity:5000, bs:"B"}]);
    myTable.populate([]);
  }, 3000);


</script>
<script type="text/javascript">
/*
    here we fill the summary table
*/
//names of columns in header
var st_left = {
    section: "",
    columns: [
          {
            columnName:"id",
            displayName:""
          }
    ]
};
var st_right = {
    section: "",
    columns: [
      {columnName:"nbr",displayName:"Number", calc:countOrders}
    , {columnName:"nbv",displayName:"NBV", calc:calcNBV}
    ]
};
function countOrders(things) {
  // we refer to a different table so we have to use dataTableSelector functions directly
  // instead of the helper functions of the passed 'things' object
  var sides = dataTableSelector.columnSelector("sot", "bs");
  switch (things.getColInRow("id")) {
    case "Buy":
      return sides.filter(function (a) {
        return a == "B";
      }).length;
    case "Sell":
        return sides.filter(function (a) {
          return a == "S";
        }).length;
    default:
      return "Oops, somebody can't code";
  }
}
function calcNBV(things) {
  var ourSide = things.getColInRow("id");
  var sides = dataTableSelector.columnSelector("sot", "bs");
  var tradedValue = dataTableSelector.columnSelector("sot", "tradedValue");
  var tradedValueThisSide = tradedValue.filter(function(v,i){
    return ourSide.indexOf(sides[i]) == 0; //javascript doesn't have startsWith yet
  });
  if (tradedValueThisSide.length > 0) {
    var totalValue = tradedValueThisSide.sum();
    if (ourSide == "Sell") {
      return totalValue;
    } else if(ourSide == "Buy"){
      return totalValue * (-1);
    } else {
      return "Oops, somebody can't code";
    }
  } else {
    return 0;
  }
}

var st_data = [
   {id:"Buy"},
   {id:"Sell"}
 ];
 var st_foot = [ {columnName:"nbr", calc:fCount}, // we need named functions if we want to define them after this
                 {columnName:"nbv", calc:fNBV}
               ];

 function fNBV(things) {
   return things.getCol("nbv").sum();
 };
 function fCount(things) {
    return things.getCol("nbr").sum();
 }

var summaryTable = new dataTable("st",[st_left, st_right], "id", st_foot, formatNumber, ['sot']);
summaryTable.populate(st_data);
</script>



<div id="pieChart"></div>
<script src="3rd_party\d3.min.js"></script>
<script src="3rd_party\d3pie.js"></script>
<script src="data.js"></script>
<script type="text/javascript">
var pie = new d3pie("pieChart", {
	"header": {
		"title": {
			"text": "Lots of Programming Languages"
		}
	},

	"size": {
		"canvasWidth": 500,
		"canvasHeight": 500,
		"pieOuterRadius": "90%"
	},
	"data": {
		"sortOrder": "value-desc",
		"content": programmingLanguages
	},
	"labels": {
		"outer": {
			"pieDistance": 32
		},
		"inner": {
			"hideWhenLessThanPercentage": 3
		},
		"mainLabel": {
			"fontSize": 11
		},
		"percentage": {
			"color": "#ffffff",
			"decimalPlaces": 0
		},
		"value": {
			"color": "#adadad",
			"fontSize": 11
		},
		"lines": {
			"enabled": true
		},
		"truncation": {
			"enabled": true
		}
	},
	"effects": {
		"pullOutSegmentOnClick": {
			"effect": "linear",
			"speed": 400,
			"size": 8
		}
	},
	"misc": {
		"gradient": {
			"enabled": true,
			"percentage": 100
		}
	}
});
</script>
</body>
</html>
